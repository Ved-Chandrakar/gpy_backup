<%- include('../partials/header') %>

<div class="container-fluid py-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h2 mb-0">
                        <i class="fas fa-camera text-warning me-2"></i>
                        फोटो प्रबंधन
                    </h1>
                    <p class="text-muted">पौधों की फोटो गैलरी और प्रबंधन</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h4 class="mb-0"><%= totalPhotos %></h4>
                            <p class="mb-0">कुल फोटो</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-camera fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h4 class="mb-0"><%= photos.filter(p => p.is_verified).length %></h4>
                            <p class="mb-0">सत्यापित फोटो</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h4 class="mb-0"><%= photos.filter(p => !p.is_verified).length %></h4>
                            <p class="mb-0">असत्यापित फोटो</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h4 class="mb-0"><%= page %></h4>
                            <p class="mb-0">पेज <%= totalPages %> में से</p>
                        </div>
                        <div class="flex-shrink-0">
                            <i class="fas fa-file-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-search me-2"></i>
                खोज और फिल्टर
            </h6>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">माता का नाम या बच्चे का नाम से खोजें</label>
                    <input type="text" class="form-control" name="search" placeholder="माता का नाम या बच्चे का नाम खोजें..." value="<%= req.query.search || '' %>">
                </div>
                <div class="col-md-3">
                    <label class="form-label">पौधे की श्रेणी</label>
                    <select name="plant_category" class="form-select">
                        <option value="">सभी पौधे</option>
                        <option value="fruit" <%= req.query.plant_category === 'fruit' ? 'selected' : '' %>>फल</option>
                        <option value="medicinal" <%= req.query.plant_category === 'medicinal' ? 'selected' : '' %>>औषधीय</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary flex-fill">
                            <i class="fas fa-search me-1"></i>खोजें
                        </button>
                        <% if (req.query.search || req.query.plant_category) { %>
                            <a href="/admin/photos" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                        <% } %>
                    </div>
                </div>
            </form>
            
            <!-- Active Filters Display -->
            <% if (req.query.search || req.query.plant_category) { %>
                <div class="mt-3">
                    <small class="text-muted me-2">सक्रिय फिल्टर:</small>
                    <% if (req.query.search) { %>
                        <span class="badge bg-info me-2">
                            <i class="fas fa-search me-1"></i>खोज: <%= req.query.search %>
                        </span>
                    <% } %>
                    <% if (req.query.plant_category) { %>
                        <span class="badge bg-success me-2">
                            <i class="fas fa-leaf me-1"></i>श्रेणी: 
                            <%= req.query.plant_category === 'fruit' ? 'फल' : 
                                req.query.plant_category === 'medicinal' ? 'औषधीय' : 
                                req.query.plant_category %>
                        </span>
                    <% } %>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Photos Grid -->
    <div class="row">
        <% if (photos && photos.length > 0) { %>
            <% photos.forEach(photo => { %>
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        <div class="position-relative">
                            <img src="/<%= photo.photo_url.replace(/\\/g, '/') %>" class="card-img-top" alt="Plant Photo" style="height: 250px; object-fit: cover;">
                        </div>
                        <div class="card-body">
                            <h6 class="card-title mb-2">
                                <i class="fas fa-female text-primary me-1"></i>
                                <%= photo.mother_name %>
                            </h6>
                            
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <strong>बच्चे का क्रम:</strong><br>
                                        <span class="badge bg-info">
                                            <%= photo.child_order === 'first' ? 'पहला' : 
                                                photo.child_order === 'second' ? 'दूसरा' : 
                                                photo.child_order === 'third' ? 'तीसरा' : 
                                                photo.child_order === 'fourth' ? 'चौथा' : 
                                                photo.child_order %>
                                        </span>
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <strong>पौधा श्रेणी:</strong><br>
                                        <span class="badge bg-secondary">
                                            <%= photo.plant_category === 'fruit' ? 'फल' : 
                                                photo.plant_category === 'flower' ? 'फूल' : 
                                                photo.plant_category === 'medicinal' ? 'औषधीय' : 
                                                photo.plant_category === 'vegetable' ? 'सब्जी' : 
                                                photo.plant_category %>
                                        </span>
                                    </small>
                                </div>
                            </div>
                            
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <small class="text-muted">
                                        <strong>अपलोड तिथि:</strong><br>
                                        <i class="fas fa-calendar me-1"></i>
                                        <%= new Date(photo.upload_date).toLocaleDateString('hi-IN', { 
                                            year: 'numeric', 
                                            month: 'short', 
                                            day: 'numeric' 
                                        }) %>
                                    </small>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">
                                        <strong>अंतिम तिथि:</strong><br>
                                        <i class="fas fa-clock me-1"></i>
                                        <% if (photo.due_date) { %>
                                            <%= new Date(photo.due_date).toLocaleDateString('hi-IN', { 
                                                year: 'numeric', 
                                                month: 'short', 
                                                day: 'numeric' 
                                            }) %>
                                        <% } else { %>
                                            अनुपलब्ध
                                        <% } %>
                                    </small>
                                </div>
                            </div>

                            <% if (photo.notes) { %>
                                <p class="card-text mt-2">
                                    <small class="text-muted">
                                        <strong>टिप्पणी:</strong> <%= photo.notes %>
                                    </small>
                                </p>
                            <% } %>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-outline-danger w-100 delete-photo-btn" data-photo-id="<%= photo.id %>" title="फोटो हटाएं">
                                <i class="fas fa-trash me-2"></i>हटाएं
                            </button>
                        </div>
                    </div>
                </div>
            <% }); %>
        <% } else { %>
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">कोई फोटो नहीं मिली</h5>
                        <p class="text-muted">अभी तक कोई फोटो अपलोड नहीं की गई है</p>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

    <!-- Pagination -->
    <% if (totalPages > 1) { %>
        <% 
            // Helper function to build URL with preserved query parameters
            function buildPaginationUrl(pageNum) {
                const params = new URLSearchParams();
                params.set('page', pageNum);
                
                // Preserve existing query parameters
                if (req.query.search) params.set('search', req.query.search);
                if (req.query.plant_category) params.set('plant_category', req.query.plant_category);
                
                return '?' + params.toString();
            }

            // Smart pagination logic
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPageNum - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
        %>
        <div class="d-flex justify-content-center mt-4">
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm">
                    <!-- First page and Previous -->
                    <% if (currentPageNum > 1) { %>
                        <li class="page-item">
                            <a class="page-link" href="<%= buildPaginationUrl(1) %>" title="पहला पेज">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="<%= buildPaginationUrl(currentPageNum - 1) %>" title="पिछला पेज">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                    <% } %>
                    
                    <!-- Show dots if there are pages before our range -->
                    <% if (startPage > 1) { %>
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    <% } %>
                    
                    <!-- Page numbers in range -->
                    <% for (let i = startPage; i <= endPage; i++) { %>
                        <li class="page-item <%= i === currentPageNum ? 'active' : '' %>">
                            <a class="page-link" href="<%= buildPaginationUrl(i) %>"><%= i %></a>
                        </li>
                    <% } %>
                    
                    <!-- Show dots if there are pages after our range -->
                    <% if (endPage < totalPages) { %>
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    <% } %>
                    
                    <!-- Next and Last page -->
                    <% if (currentPageNum < totalPages) { %>
                        <li class="page-item">
                            <a class="page-link" href="<%= buildPaginationUrl(currentPageNum + 1) %>" title="अगला पेज">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="<%= buildPaginationUrl(totalPages) %>" title="अंतिम पेज">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                    <% } %>
                </ul>
            </nav>
        </div>
    <% } %>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoModalLabel">फोटो विवरण</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img id="modalPhoto" src="" class="img-fluid" alt="Plant Photo">
                <div id="photoDetails" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<script>
// Wait for DOM to load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, looking for delete buttons...');
    
    // Add event listeners to all delete buttons
    const deleteButtons = document.querySelectorAll('.delete-photo-btn');
    console.log('Found delete buttons:', deleteButtons.length);
    
    deleteButtons.forEach((button, index) => {
        console.log('Attaching listener to button', index, 'with photo ID:', button.getAttribute('data-photo-id'));
        button.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Delete button clicked!');
            const photoId = this.getAttribute('data-photo-id');
            console.log('Photo ID to delete:', photoId);
            deletePhoto(photoId);
        });
    });
    
    // Also add click listeners for debugging
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-photo-btn')) {
            console.log('Delete button area clicked');
        }
    });
});

async function deletePhoto(photoId) {
    console.log('deletePhoto function called with ID:', photoId);
    
    if (confirm('क्या आप वाकई इस फोटो को हटाना चाहते हैं? यह कार्य वापस नहीं किया जा सकता।')) {
        try {
            console.log('User confirmed deletion, proceeding...');
            console.log('Deleting photo:', photoId);
            
            const response = await fetch(`/admin/photos/${photoId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'same-origin'
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}, body: ${errorText}`);
            }

            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.success) {
                alert('फोटो सफलतापूर्वक हटा दी गई');
                location.reload();
            } else {
                alert('त्रुटि: ' + (data.message || 'फोटो हटाने में त्रुटि हुई'));
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('कुछ गलत हुआ है: ' + error.message);
        }
    } else {
        console.log('User cancelled deletion');
    }
}
</script>

<%- include('../partials/footer') %>
